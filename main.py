import sqlite3
import random
import telebot
from telebot import types

TOKEN = None
with open('token.txt') as f:
    TOKEN = f.read().strip()
bot = telebot.TeleBot(TOKEN)

conn = sqlite3.connect('database.db', check_same_thread=False)
cursor = conn.cursor()

# comments for answers
comments_for_right_answers = ['–ü—Ä–∞–≤–∏–ª—å–Ω–æ!', '–í–µ—Ä–Ω–æ!', '–ú–æ–ª–æ–¥–µ—Ü! üòâ', '–í–∞—É, —ç—Ç–æ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç! üî•',
                              '–°–æ–≤–µ—Ä—à–µ–Ω–Ω–æ –≤–µ—Ä–Ω–æ!', '–ö–ª–∞—Å—Å, –≤—Å–µ –≤–µ—Ä–Ω–æ!', '–û—Ç–ª–∏—á–Ω–æ! üëç', '–í—Å–µ –≤–µ—Ä–Ω–æ!',
                              '–î–∞, —Ç–∞–∫ –¥–µ—Ä–∂–∞—Ç—å! üí™']

comments_for_incorrect_answers = ['–ü–æ–ø—Ä–æ–±—É–π –µ—â–µ —Ä–∞–∑', '–ù–µ —Å–æ–≤—Å–µ–º...',
                                  '–ù–µ —Å–æ–≤—Å–µ–º —Ç–∞–∫. –°–¥–µ–ª–∞–π –µ—â–µ –ø–æ–ø—ã—Ç–∫—É üòâ']

# function for queries
def execute_queries(word_count):
    if word_count == 1:
        cursor.execute("SELECT eng, rus FROM english_words ORDER BY RANDOM() LIMIT 1")
        result = cursor.fetchone()
        return result
    elif word_count == 10:
        cursor.execute("SELECT eng, rus FROM english_words ORDER BY RANDOM() LIMIT 10")
        result = cursor.fetchall()
        return result

# function for markup
def show_markup(width):
    markup = types.ReplyKeyboardMarkup(resize_keyboard=True, row_width=width)
    if width == 2:
        random_1 = types.KeyboardButton('–†–∞–Ω–¥–æ–º–Ω–æ–µ —Å–ª–æ–≤–æ')
        random_10 = types.KeyboardButton('10 —Ä–∞–Ω–¥–æ–º–Ω—ã—Ö —Å–ª–æ–≤')
        train_rus = types.KeyboardButton('–ü–æ—Ç—Ä–µ–Ω–∏—Ä–æ–≤–∞—Ç—å—Å—è (rus-eng)')
        train_eng = types.KeyboardButton('–ü–æ—Ç—Ä–µ–Ω–∏—Ä–æ–≤–∞—Ç—å—Å—è (eng-rus)')
        markup.add(random_1, random_10, train_rus, train_eng)
        return markup
    elif width == 3:
        correct_answer = types.KeyboardButton('–ü–æ–∫–∞–∑–∞—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç')
        random_1 = types.KeyboardButton('–†–∞–Ω–¥–æ–º–Ω–æ–µ —Å–ª–æ–≤–æ')
        random_10 = types.KeyboardButton('10 —Ä–∞–Ω–¥–æ–º–Ω—ã—Ö —Å–ª–æ–≤')
        train_rus = types.KeyboardButton('–ü–æ—Ç—Ä–µ–Ω–∏—Ä–æ–≤–∞—Ç—å—Å—è (rus-eng)')
        train_eng = types.KeyboardButton('–ü–æ—Ç—Ä–µ–Ω–∏—Ä–æ–≤–∞—Ç—å—Å—è (eng-rus)')
        markup.row(correct_answer).add(random_1, random_10).add(train_rus, train_eng)
        return markup

# start
@bot.message_handler(commands=['start'])
def start(message):
    markup = show_markup(2)
    mess = f'–ü—Ä–∏–≤–µ—Ç! \n2 000 –∞–Ω–≥–ª–∏–π—Å–∫–∏—Ö —Å–ª–æ–≤ –ø–æ–∫—Ä—ã–≤–∞—é—Ç –ø—Ä–∏–º–µ—Ä–Ω–æ 80-90% —É—Å—Ç–Ω–æ–π —Ä–µ—á–∏. –≠—Ç–æ –æ–∑–Ω–∞—á–∞–µ—Ç, —á—Ç–æ –∑–∞–ø–æ–º–Ω–∏–≤ –≤—Å–µ–≥–æ ' \
           f'2 000 —Å–ª–æ–≤, –≤—ã —Å–º–æ–∂–µ—Ç–µ —Å –ª–µ–≥–∫–æ—Å—Ç—å—é –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å –æ–±—â–µ–Ω–∏–µ –Ω–∞ –ø–æ–≤—Å–µ–¥–Ω–µ–≤–Ω—ã–µ —Ç–µ–º—ã. ' \
           f'–ò–∑—É—á–∞—è –ø–æ 10 —Å–ª–æ–≤ –≤ –¥–µ–Ω—å, –≤—ã —Å–º–æ–∂–µ—Ç–µ –æ—Å–≤–æ–∏—Ç—å –≤—Å–µ 2 000 —Å–ª–æ–≤ –ø—Ä–∏–º–µ—Ä–Ω–æ –∑–∞ –ø–æ–ª–≥–æ–¥–∞. ' \
           f'–ê —ç—Ç–æ—Ç –±–æ—Ç –ø–æ–º–æ–∂–µ—Ç –≤–∞–º –≤ —ç—Ç–æ–º. –£–¥–∞—á–∏! ' \
           f'–ò –≥–ª–∞–≤–Ω–æ–µ –ø–æ–º–Ω–∏—Ç–µ, —á—Ç–æ –∑–∞–Ω–∏–º–∞—Ç—å—Å—è –Ω—É–∂–Ω–æ –µ–∂–µ–¥–Ω–µ–≤–Ω–æ —Ö–æ—Ç—è –±—ã –ø–æ 5 –º–∏–Ω—É—Ç üòâ' \
           f'–í—ã–±–µ—Ä–∏ –ª—é–±—É—é –∫–æ–º–∞–Ω–¥—É –≤ –º–µ–Ω—é, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å –æ–±—É—á–µ–Ω–∏–µ üëá'
    bot.send_message(message.chat.id, mess, parse_mode='html', reply_markup=markup)

# main commands (menu)
@bot.message_handler(content_types=['text'])
def mess(message):
    get_message_bot = message.text.strip().lower()
    if get_message_bot == '—Ä–∞–Ω–¥–æ–º–Ω–æ–µ —Å–ª–æ–≤–æ':
        words = execute_queries(1)
        final_message = f"<b>{words[0]}</b> - {words[1]}"
        markup = show_markup(2)
        bot.send_message(message.chat.id, final_message, parse_mode='html', reply_markup=markup)

    elif get_message_bot == '10 —Ä–∞–Ω–¥–æ–º–Ω—ã—Ö —Å–ª–æ–≤':
        words = execute_queries(10)
        final_message = ""
        for word in words:
            final_message += f"<b>{word[0]}</b> - {word[1]} \n"
        markup = show_markup(2)
        bot.send_message(message.chat.id, final_message, parse_mode='html', reply_markup=markup)

    elif get_message_bot == '–ø–æ—Ç—Ä–µ–Ω–∏—Ä–æ–≤–∞—Ç—å—Å—è (rus-eng)':
        words = execute_queries(1)
        rus_word = f"{words[1]}"
        markup = show_markup(3)
        msg = bot.send_message(message.chat.id, rus_word, reply_markup=markup)
        bot.register_next_step_handler(msg, verify_rus_eng_answer, words)

    elif get_message_bot == '–ø–æ—Ç—Ä–µ–Ω–∏—Ä–æ–≤–∞—Ç—å—Å—è (eng-rus)':
        words = execute_queries(1)
        eng_word = f"{words[0]}"
        markup = show_markup(3)
        msg = bot.send_message(message.chat.id, eng_word, reply_markup=markup)
        bot.register_next_step_handler(msg, verify_eng_rus_answer, words)
    else:
        bot.send_message(message.chat.id, '–í—ã–±–µ—Ä–∏ –∫–æ–º–∞–Ω–¥—É –∏–∑ —Å–ø–∏—Å–∫–∞ üëá')

# train rus-eng
def get_rus_eng_answer(message, select_words):
    get_words = select_words
    markup = show_markup(3)
    msg = bot.send_message(message.chat.id, get_words[1], reply_markup=markup)
    bot.register_next_step_handler(msg, verify_rus_eng_answer, get_words)

def verify_rus_eng_answer(message, verify_words):
    get_words = verify_words
    if message.text.strip().lower() == get_words[0]:
        markup = show_markup(2)
        bot.send_message(message.chat.id, random.choice(comments_for_right_answers), parse_mode='html',
                         reply_markup=markup)
    elif message.text.strip().lower() == '–ø–æ–∫–∞–∑–∞—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç':
        markup = show_markup(2)
        bot.send_message(message.chat.id, get_words[0], reply_markup=markup)
    elif message.text.strip().lower() in ['—Ä–∞–Ω–¥–æ–º–Ω–æ–µ —Å–ª–æ–≤–æ', '10 —Ä–∞–Ω–¥–æ–º–Ω—ã—Ö —Å–ª–æ–≤',
                                          '–ø–æ—Ç—Ä–µ–Ω–∏—Ä–æ–≤–∞—Ç—å—Å—è (rus-eng)', '–ø–æ—Ç—Ä–µ–Ω–∏—Ä–æ–≤–∞—Ç—å—Å—è (eng-rus)']:
        mess(message)
    else:
        bot.send_message(message.chat.id, random.choice(comments_for_incorrect_answers))
        get_rus_eng_answer(message, get_words)

# train eng-rus
def get_eng_rus_answer(message, select_words):
    get_words = select_words
    markup = show_markup(3)
    msg = bot.send_message(message.chat.id, get_words[0], reply_markup=markup)
    bot.register_next_step_handler(msg, verify_eng_rus_answer, get_words)

def verify_eng_rus_answer(message, verify_words):
    get_words = verify_words
    if message.text.strip().lower() in get_words[1].split(sep=', '):
        markup = show_markup(2)
        bot.send_message(message.chat.id, random.choice(comments_for_right_answers), reply_markup=markup)
    elif message.text.strip().lower() == '–ø–æ–∫–∞–∑–∞—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç':
        markup = show_markup(2)
        bot.send_message(message.chat.id, get_words[1], reply_markup=markup)
    elif message.text.strip().lower() in ['—Ä–∞–Ω–¥–æ–º–Ω–æ–µ —Å–ª–æ–≤–æ', '10 —Ä–∞–Ω–¥–æ–º–Ω—ã—Ö —Å–ª–æ–≤',
                                          '–ø–æ—Ç—Ä–µ–Ω–∏—Ä–æ–≤–∞—Ç—å—Å—è (rus-eng)', '–ø–æ—Ç—Ä–µ–Ω–∏—Ä–æ–≤–∞—Ç—å—Å—è (eng-rus)']:
        mess(message)
    else:
        bot.send_message(message.chat.id, random.choice(comments_for_incorrect_answers))
        get_eng_rus_answer(message, get_words)

bot.polling(none_stop=True)